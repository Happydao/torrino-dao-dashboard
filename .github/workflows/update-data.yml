name: Update Treasury Data
on:
  schedule:
    - cron: '0 4 * * *'  # 04:00 UTC (05:00/06:00 IT in base all'ora legale)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.G_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install puppeteer axios dotenv
          npm install @solana/web3.js

      # ‚ñ∂Ô∏è Esegue gli script con log in diretta e li salva su file
      - name: Run scripts with live logging + build logs.json & logs.txt
        env:
          G_TOKEN: ${{ secrets.G_TOKEN }}
          HELIUS_API_KEY: ${{ secrets.HELIUS_API_KEY }}
          TENSOR_API_KEY: ${{ secrets.TENSOR_API_KEY }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        shell: bash
        run: |
          set -o pipefail

          START="$(date -u +%FT%TZ)"

          # Esecuzione con streaming + copia su file
          node scripts/totalvalue.js 2>&1 | tee out_totalvalue.log
          RC1=${PIPESTATUS[0]}

          node scripts/calculate.js 2>&1 | tee out_calculate.log
          RC2=${PIPESTATUS[0]}

          END="$(date -u +%FT%TZ)"

          # Writer JS che legge i file (niente jq/apt)
          cat > .github/write-logs.mjs <<'NODE'
          import fs from 'fs';

          const runId = Number(process.env.GITHUB_RUN_ID || '0');
          const startedAt = process.env.STARTED_AT || new Date().toISOString();
          const finishedAt = process.env.FINISHED_AT || new Date().toISOString();
          const out1File = process.env.OUT1_FILE || 'out_totalvalue.log';
          const out2File = process.env.OUT2_FILE || 'out_calculate.log';
          const rc1 = Number(process.env.RC1 || 1);
          const rc2 = Number(process.env.RC2 || 1);
          const ok = (rc1 === 0 && rc2 === 0);

          const read = (p) => fs.existsSync(p) ? fs.readFileSync(p, 'utf8') : '';
          const mask = s => (s || '').replace(/[A-Za-z0-9_\-]{32,}/g, '[REDACTED]');

          const out1 = mask(read(out1File));
          const out2 = mask(read(out2File));

          const raw = [
            '=== Update Treasury Data ===',
            `Started at: ${startedAt}`,
            '',
            '----- totalvalue.js -----',
            out1,
            '',
            '----- calculate.js -----',
            out2,
            '',
            `Finished at: ${finishedAt}`,
            `Status: ${ok}`
          ].join('\n');

          fs.writeFileSync('logs.txt', raw, 'utf8');

          const payload = {
            runId,
            startedAt,
            finishedAt,
            ok,
            steps: [
              { name: 'totalvalue.js', exitCode: rc1, output: out1 },
              { name: 'calculate.js', exitCode: rc2, output: out2 }
            ],
            raw
          };
          fs.writeFileSync('logs.json', JSON.stringify(payload, null, 2), 'utf8');

          const tsSafe = startedAt.replace(/:/g, '-');
          fs.mkdirSync('logs', { recursive: true });
          fs.copyFileSync('logs.txt', `logs/${tsSafe}_run-${runId}.txt`);
          fs.copyFileSync('logs.json', `logs/${tsSafe}_run-${runId}.json`);
          NODE

          # ‚ö†Ô∏è Qui PASSO davvero le env al processo Node (prima era argomento, non env)
          STARTED_AT="$START" \
          FINISHED_AT="$END" \
          RC1="$RC1" RC2="$RC2" \
          OUT1_FILE="out_totalvalue.log" \
          OUT2_FILE="out_calculate.log" \
          node .github/write-logs.mjs

      - name: Check file changes
        run: |
          echo "üìÇ Anteprima logs.txt:"
          head -n 40 logs.txt || true
          echo ""
          echo "üìÇ Anteprima logs.json:"
          head -c 1000 logs.json || true
          echo ""
          echo "üìÇ Git status:"
          git status
        continue-on-error: true

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data.json logs.json logs.txt logs
          git commit -m "üîÑ Aggiornamento tesoreria + logs.json + logs.txt" || echo "Nessun cambiamento da committare"
          git push origin main
