<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Torrino DAO NFT Dashboard</title>

  <!-- Typography -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg:#070a12;
      --bg-2:#0b1220;
      --panel: rgba(17,24,39,.55);
      --panel-strong: rgba(17,24,39,.75);
      --border: rgba(255,255,255,.22); /* stronger */
      --txt:#e7e9ee;
      --muted:#a1a8b3;
      --primary:#00e0ff;   /* neon cyan */
      --secondary:#a855f7; /* violet */
      --accent:#00ffa3;    /* solana green */
      --warning:#ffcc00;
      --success:#00d38d;
      --danger:#ff5c7a;
      --radius:18px;
      --shadow: 0 14px 36px rgba(0,0,0,.45), 0 0 0 2px var(--border) inset; /* thicker outline */
      --outline: 2px; /* card borders more accentuated */
    }

    *{ box-sizing: border-box }
    html,body{ height:100% }

    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--txt);
      background:
        radial-gradient(1200px 600px at 100% -10%, rgba(168,85,247,.18), transparent 60%),
        radial-gradient(800px 400px at -10% 20%, rgba(0,255,163,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg-2));
      overflow-x:hidden;
      letter-spacing:.2px;
    }

    .backgrid{ position: fixed; inset: 0; pointer-events:none; z-index:0;
      background-image:
        linear-gradient(rgba(255,255,255,.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.03) 1px, transparent 1px);
      background-size: 22px 22px, 22px 22px;
      mask-image: radial-gradient(1200px 600px at 50% -10%, rgba(0,0,0,.7), transparent 75%);
    }

    .wrapper{ position: relative; z-index:1; max-width:1200px; margin: 36px auto 80px; padding: 0 18px; }

    /* Header */
    .header{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 20px; }

    .brand{ display:flex; align-items:center; gap:14px; }
    .brand img{
      width:64px; height:auto; object-fit:contain; display:block;
      border-radius:0;
      filter: drop-shadow(0 6px 18px rgba(0,224,255,.25));
    }
    .brand .title{ display:flex; flex-direction:column; }
    .brand h1{ margin:0; font-size: clamp(20px, 3.2vw, 28px); font-weight:800; letter-spacing:.3px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
      -webkit-background-clip: text; background-clip: text; color: transparent; }
    .brand small{ color: var(--muted); margin-top:2px; font-weight:500; }

    .top-links{ display:flex; align-items:center; flex-wrap:wrap; gap:10px; }
    .chip, .icon-btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 12px; text-decoration:none; color: var(--txt);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: var(--outline) solid var(--border); border-radius: 14px; box-shadow: var(--shadow);
      transition: transform .15s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease;
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); font-weight:600; font-size: 14px;
    }
    .chip:hover, .icon-btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.28);
      box-shadow: 0 12px 30px rgba(0,224,255,.12), 0 0 0 2px rgba(255,255,255,.12) inset; }
    .icon-btn{ width:42px; height:42px; padding:0; justify-content:center; }
    .icon-btn img{ width:20px; height:20px; filter: saturate(1.1) brightness(1.05) }
    .icon-btn img.x-icon{ filter: invert(1) brightness(1.2) !important; }

    /* Panels & sections */
    .section{
      padding: 18px; border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.035));
      border: var(--outline) solid var(--border); box-shadow: var(--shadow);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); margin-top:18px;
    }
    .section h2{ margin: 4px 0 14px; font-size: clamp(18px, 2.2vw, 22px); font-weight:800; letter-spacing:.2px; }
    .eyebrow{ display:inline-flex; align-items:center; gap:8px; font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.18em; color: var(--accent); }

    /* Composite panel */
    .panel{ border: var(--outline) solid var(--border); border-radius:16px; box-shadow: var(--shadow);
            background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); padding:16px; }
    .composite-grid{ display:grid; grid-template-columns: 1fr; gap:16px; align-items:center; }
    .composite-grid .left{ min-width:0 }
    .composite-grid .right{ min-width:0 }
    .metrics{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .metric{ padding:12px; border-radius:12px; border: var(--outline) solid var(--border); background: rgba(255,255,255,.02); }
    .m-label{ color: var(--muted); font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.06em }
    .m-value{ margin-top:6px; font-family: 'JetBrains Mono', ui-monospace; font-weight:800; font-size: clamp(18px, 2.6vw, 22px) }
    .m-sub{ margin-top:4px; color: var(--muted); font-size:12px }
    @media(min-width: 980px){
      .composite-grid{ grid-template-columns: 1.1fr .9fr }
      .metrics{ grid-template-columns: 1fr }
      .composite-grid .right{ border-left: 1px solid var(--border); padding-left:16px }
    }

    /* Discounts & buttons */
    .buy-actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    .btn{ appearance:none; border:none; cursor:pointer; font-weight:800; letter-spacing:.2px; padding:12px 16px; border-radius:12px;
      background: linear-gradient(90deg, var(--primary), var(--accent)); color:#0b1220; box-shadow: 0 10px 26px rgba(0,224,255,.22);
      text-decoration:none; display:inline-flex; align-items:center; gap:8px; transition: transform .12s ease, filter .12s ease, box-shadow .12s ease; }
    .btn:hover{ transform: translateY(-1px); filter:brightness(1.02) }

    .note{ color: var(--muted); font-size: 14px; line-height:1.6; }
    .highlight{ color: var(--warning); font-weight:700 }

    /* Charts grid */
    .charts{ display:grid; gap:12px; margin-top:8px; grid-template-columns: 1fr; }
    @media (min-width: 980px){ .charts{ grid-template-columns: 1fr 1fr; } .charts .chart.full{ grid-column: 1 / -1; } }
    .chart{ border:var(--outline) solid var(--border); border-radius:16px; overflow:hidden; background: #0e1526; box-shadow: var(--shadow); }
    .chart iframe{ display:block; width:100%; height:440px; border:0 }

    /* Update/footnote */
    .footnote{ margin-top: 8px; font-size: 12px; color: var(--muted); display:flex; flex-wrap:wrap; gap:16px; }

    /* Skeleton loading */
    .skeleton{ position: relative; background: linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.04), rgba(255,255,255,.08)); background-size: 200% 100%; animation: shine 1.1s linear infinite; color: transparent !important; border-radius: 8px; display:inline-block; line-height:1.1; }
    @keyframes shine{ 0% { background-position: 200% 0 } 100% { background-position: -200% 0 } }

    /* Two-up grid helper */
    .row{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media(min-width: 900px){ .row{ grid-template-columns: 1fr 1fr } }

    a{ color: var(--primary) }

    /* ==== MINI PIE CHARTS ==== */
    .mini-pie{ display:flex; align-items:center; gap:14px; padding:12px; border-radius:14px; border:var(--outline) solid var(--border); box-shadow: var(--shadow);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); }
    .pie{ width:92px; height:92px; border-radius:50%; position:relative; flex:0 0 auto; background:#0b1220; }
    .pie::after{ content:""; position:absolute; inset:12px; border-radius:50%; background:#0e1526; display:block; }
    .legend{ display:flex; flex-direction:column; gap:6px; font-size:13px; }
    .legend b{ font-weight:800 }
    .badge{ display:inline-flex; align-items:center; gap:6px; }
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }

    /* Footer */
    footer{ text-align:center }
    footer small{ color: var(--muted) }

    /* ====== NEW: heading actions (right aligned link) ====== */
    .heading-actions{
      display:flex; justify-content:flex-end; gap:10px; margin-top:-6px; margin-bottom: 8px; flex-wrap:wrap;
    }

    /* ====== NEW: Modal styles for logs ====== */
    .modal{
      position: fixed; inset:0; display:none; place-items:center; z-index: 50;
      background: radial-gradient(1000px 600px at 50% -10%, rgba(0,224,255,.12), transparent 70%),
                  rgba(5,8,15,.66);
      backdrop-filter: blur(4px);
    }
    .modal.open{ display:grid; }
    .modal-card{
      width:min(980px, 94vw); max-height:min(86vh, 840px);
      border-radius: 18px;
      border: var(--outline) solid var(--border);
      box-shadow: 0 24px 60px rgba(0,0,0,.5), 0 0 0 2px rgba(255,255,255,.06) inset;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.035));
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .modal-header{
      padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    }
    .modal-title{
      font-weight:800; letter-spacing:.25px; font-size:16px;
      display:flex; align-items:center; gap:10px;
    }
    .close-btn{
      appearance:none; border:none; background:transparent; color:var(--txt); cursor:pointer;
      width:36px; height:36px; border-radius:10px;
      display:inline-grid; place-items:center;
    }
    .close-btn:hover{ background: rgba(255,255,255,.08) }

    .modal-tools{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .tool-btn{
      appearance:none; border:none; cursor:pointer; font-weight:700; padding:8px 10px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: var(--outline) solid var(--border); color: var(--txt);
    }
    .tool-btn:hover{ transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,224,255,.14) }

    .modal-body{
      padding: 0; overflow:auto; background:#0a0f1f;
    }
    .logview{
      margin:0; padding:16px; font-family:'JetBrains Mono', ui-monospace, monospace; font-size:12.5px; line-height:1.5;
      white-space:pre-wrap; word-break:break-word; color:#e7e9ee;
      min-height: 300px; max-height: 60vh;
      background:
        linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.0)),
        repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0px, rgba(255,255,255,.04) 1px, transparent 1px, transparent 22px);
    }

    .modal-footer{
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; color:var(--muted);
      border-top: 1px solid var(--border); background: rgba(255,255,255,.03);
      font-size:12px;
    }

    .switch{
      display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:10px;
      border: var(--outline) solid var(--border); background: rgba(255,255,255,.02);
      user-select:none;
    }
    .switch input{ accent-color: var(--accent); width:16px; height:16px }

    /* Small helper for the raw link */
    .raw-link{ text-decoration:none; }
  </style>
</head>
<body>
  <div class="backgrid" aria-hidden="true"></div>

  <div class="wrapper">
    <!-- HEADER -->
    <header class="header">
      <div class="brand">
        <img src="torrino-dao.png" alt="Torrino DAO Logo" />
        <div class="title">
          <h1>Torrino DAO — NFT Dashboard</h1>
          <small>On-chain analytics • NFTs • Treasury</small>
        </div>
      </div>

      <nav class="top-links">
        <a class="icon-btn" href="https://github.com/Happydao/torrino-dao-dashboard" target="_blank" aria-label="GitHub">
          <img src="https://cdn-icons-png.flaticon.com/512/733/733553.png" alt="GitHub" />
        </a>
        <a class="icon-btn" href="https://discord.gg/yYkwEjcKa9" target="_blank" aria-label="Discord">
          <img src="https://cdn-icons-png.flaticon.com/512/3670/3670157.png" alt="Discord" />
        </a>
        <a class="icon-btn" href="https://twitter.com/Torrino_DAO" target="_blank" aria-label="Twitter (X)">
          <img class="x-icon" src="https://cdn-icons-png.flaticon.com/512/5968/5968958.png" alt="Twitter (X)" />
        </a>
        <a class="chip" href="https://app.step.finance/it/portfolio?wallet=EKjb5grMX19c3cAZa5LQjqksDpqqVLTGZrswh79WkPdD" target="_blank" rel="noopener" aria-label="Step Finance Portfolio">
          📊 Step Finance Portfolio
        </a>
      </nav>
    </header>

    <!-- TREASURY & MARKET -->
    <section class="section" aria-labelledby="overview">
      <div class="eyebrow">Overview</div>
      <h2 id="overview">Treasury &amp; Market</h2>

      <!-- NEW: right-side action to open logs modal -->
      <div class="heading-actions">
        <button class="chip" id="openLogsBtn" type="button" aria-haspopup="dialog" aria-controls="logsModal">
          🧾 Public Treasury Logs
        </button>
        <noscript><a class="chip" href="logs.txt" target="_blank" rel="noopener">Open raw logs.txt</a></noscript>
      </div>

      <!-- CARD 1: Treasury Composition + metrics -->
      <div class="panel composite" style="margin-top:10px">
        <div class="composite-grid">
          <div class="left">
            <div class="label" style="text-transform:uppercase; letter-spacing:.06em; font-size:12px; color:var(--muted); font-weight:700;">Treasury Composition (Stable vs Invested)</div>
            <div class="mini-pie" style="margin-top:10px">
              <div class="pie" id="pieStable"></div>
              <div class="legend">
                <b>Allocation</b>
                <div class="badge"><span class="dot" style="background:var(--accent)"></span> Stable Coins <span id="legendStable" style="margin-left:6px; font-weight:700"></span></div>
                <div class="badge"><span class="dot" style="background:var(--secondary)"></span> Invested / Volatile <span id="legendInvested" style="margin-left:6px; font-weight:700"></span></div>
              </div>
            </div>
          </div>

          <div class="right metrics">
            <div class="metric">
              <div class="m-label">Total Treasury</div>
              <div class="m-value" id="treasuryValue"><span class="skeleton">&nbsp;</span></div>
              <div class="m-sub">100%</div>
            </div>
            <div class="metric">
              <div class="m-label">Stable Protected Capital</div>
              <div class="m-value"><span id="stableValue"><span class="skeleton">&nbsp;</span></span></div>
              <div class="m-sub">= <span id="stablePercentage"><span class="skeleton">&nbsp;</span></span>% of treasury</div>
            </div>
          </div>
        </div>
      </div>

      <!-- CARD 2: Treasury by Generation (Value) -->
      <div class="panel composite" style="margin-top:12px">
        <div class="composite-grid">
          <div class="left">
            <div class="label" style="text-transform:uppercase; letter-spacing:.06em; font-size:12px; color:var(--muted); font-weight:700;">Treasury by Generation (Value)</div>
            <div class="mini-pie" style="margin-top:10px">
              <div class="pie" id="pieGen"></div>
              <div class="legend">
                <b>Value Allocation</b>
                <div class="badge"><span class="dot" style="background:var(--primary)"></span> Gen 1 share <span id="legendGen1" style="margin-left:6px; font-weight:700"></span></div>
                <div class="badge"><span class="dot" style="background:var(--danger)"></span> Gen 2 share <span id="legendGen2" style="margin-left:6px; font-weight:700"></span></div>
              </div>
            </div>
          </div>

          <div class="right metrics">
            <div class="metric">
              <div class="m-label">Gen 1 Treasury Value</div>
              <div class="m-value" id="treasuryGen1"><span class="skeleton">&nbsp;</span></div>
              <div class="m-sub">≈ <span id="legendGen1Pct"></span></div>
            </div>
            <div class="metric">
              <div class="m-label">Gen 2 Treasury Value</div>
              <div class="m-value" id="treasuryGen2"><span class="skeleton">&nbsp;</span></div>
              <div class="m-sub">≈ <span id="legendGen2Pct"></span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footnote -->
      <div class="footnote">
        <div>Current SOL Price: <strong id="footSol"><span class="skeleton">&nbsp;</span></strong></div>
        <div>Last updated: <strong id="footUpdated"><span class="skeleton">&nbsp;</span></strong></div>
      </div>
    </section>

    <!-- NFT REAL VALUE -->
    <section class="section" aria-labelledby="nft-values">
      <div class="eyebrow">NFT</div>
      <h2 id="nft-values">Current NFT Real Value</h2>

      <div class="row">
        <div>
          <div class="stat">
            <div class="label">Torrino DAO (Gen 1 — 500 pcs)</div>
            <div class="value">
              <span id="nftGen1Value"><span class="skeleton">&nbsp;&nbsp;</span></span>
              <span class="sub">(<span id="nftGen1ValueSol"><span class="skeleton">&nbsp;</span></span>)</span>
            </div>
          </div>
        </div>
        <div>
          <div class="stat">
            <div class="label">Solnauta (Gen 2 — 888 pcs)</div>
            <div class="value">
              <span id="nftGen2Value"><span class="skeleton">&nbsp;&nbsp;</span></span>
              <span class="sub">(<span id="nftGen2ValueSol"><span class="skeleton">&nbsp;</span></span>)</span>
            </div>
          </div>
        </div>
      </div>

      <p class="note" style="margin-top:12px">
        <strong>📢 NFT Discount Analysis:</strong><br/>
        Listing prices are compared with the NFT <em>real value</em> based on the treasury. If the listing price is lower than the real value, the NFT is considered discounted and may be a better entry versus the current treasury valuation.
      </p>

      <p class="note">
        <strong>💡 Protected Capital &amp; NFT Value:</strong><br/>
        <em>Protected Capital</em> is the slice of the treasury held in stables (USDC/USDT/USDY) that preserves value regardless of market conditions. Buying a discounted NFT gives exposure to both the volatile part and the protected portion of the treasury: <span class="highlight">high discount + high protected %</span> = upside potential + capital preservation.
      </p>
    </section>

    <!-- DISCOUNTS -->
    <section class="section" aria-labelledby="discounts">
      <div class="eyebrow">Market</div>
      <h2 id="discounts">Discounts on Listed NFTs</h2>

      <div class="row">
        <div>
          <div class="stat">
            <div class="label">📉 Torrino DAO (Gen 1)</div>
            <div class="value">
              <span id="gen1ListingPrice"><span class="skeleton">&nbsp;&nbsp;</span></span>
            </div>
            <div class="sub">➡️ Difference from real value: <strong><span id="gen1Discount"><span class="skeleton">&nbsp;</span></span>%</strong></div>
            <div class="buy-actions">
              <a class="btn" href="https://www.tensor.trade/trade/torrino_dao" target="_blank" rel="noopener">🛒 Buy Torrino DAO</a>
            </div>
          </div>
        </div>

        <div>
          <div class="stat">
            <div class="label">📉 Solnauta (Gen 2)</div>
            <div class="value">
              <span id="gen2ListingPrice"><span class="skeleton">&nbsp;&nbsp;</span></span>
            </div>
            <div class="sub">➡️ Difference from real value: <strong><span id="gen2Discount"><span class="skeleton">&nbsp;</span></span>%</strong></div>
            <div class="buy-actions">
              <a class="btn" href="https://www.tensor.trade/trade/solnauta" target="_blank" rel="noopener">🛒 Buy Solnauta</a>
            </div>
          </div>
        </div>
      </div>

      <div class="footnote">Data source last updated: <strong id="marketUpdated"><span class="skeleton">&nbsp;</span></strong></div>
    </section>

    <!-- CHARTS -->
    <section class="section" aria-labelledby="charts">
      <div class="eyebrow">Analytics</div>
      <h2 id="charts">Treasury Charts</h2>

      <div class="charts">
        <div class="chart">
          <iframe
            src="https://docs.google.com/spreadsheets/d/e/2PACX-1vT84K0e8A5H3P2gI4upLGkArVFHDtXQ5uyDAfZjEHfnYsxGm0uCHwUxfTHr_zzm4jkzhUGMzdox85DT/pubchart?oid=908001184&format=interactive"
            loading="lazy" referrerpolicy="no-referrer" title="Treasury Chart 1">
          </iframe>
        </div>

        <div class="chart">
          <iframe
            src="https://docs.google.com/spreadsheets/d/e/2PACX-1vT84K0e8A5H3P2gI4upLGkArVFHDtXQ5uyDAfZjEHfnYsxGm0uCHwUxfTHr_zzm4jkzhUGMzdox85DT/pubchart?oid=1345237562&format=interactive"
            loading="lazy" referrerpolicy="no-referrer" title="Treasury Chart 2">
          </iframe>
        </div>

        <div class="chart full">
          <iframe
            src="https://docs.google.com/spreadsheets/d/e/2PACX-1vT84K0e8A5H3P2gI4upLGkArVFHDtXQ5uyDAfZjEHfnYsxGm0uCHwUxfTHr_zzm4jkzhUGMzdox85DT/pubchart?oid=1508575723&amp;format=interactive"
            loading="lazy" referrerpolicy="no-referrer" title="Treasury Table / Chart 3">
          </iframe>
        </div>
      </div>
    </section>

    <footer class="section">
      <small>Built by the community. Stay tuned.</small>
    </footer>
  </div>

  <!-- ===== NEW: Logs Modal ===== -->
  <div class="modal" id="logsModal" role="dialog" aria-modal="true" aria-labelledby="logsTitle" aria-describedby="logsDesc">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title" id="logsTitle">🧾 Public Treasury Calculation Logs <small style="color:var(--muted); font-weight:600;">(logs.txt)</small></div>
        <div class="modal-tools">
          <button class="tool-btn" id="refreshLogsBtn" type="button">Refresh</button>
          <label class="switch"><input type="checkbox" id="autoRefreshToggle" /> Live refresh</label>
          <label class="switch"><input type="checkbox" id="autoScrollToggle" checked /> Auto-scroll</label>
          <button class="tool-btn" id="copyLogsBtn" type="button">Copy</button>
          <a class="tool-btn raw-link" href="logs.txt" target="_blank" rel="noopener">Open raw</a>
          <button class="close-btn" id="closeLogsBtn" aria-label="Close">✕</button>
        </div>
      </div>
      <div class="modal-body" id="logsDesc">
        <pre class="logview" id="logsContent">Loading…</pre>
      </div>
      <div class="modal-footer">
        <div>Source: <code>/logs.txt</code> • Updated <span id="logsUpdated">—</span></div>
        <div style="opacity:.85">Tip: enable <strong>Live refresh</strong> while a run is in progress.</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Formatting helpers =====
    const fmtUsdBig = (v) => {
      const num = Number(v);
      if (isNaN(num)) return String(v);
      const opts = Number.isInteger(num) ? { maximumFractionDigits: 0 } : { maximumFractionDigits: 2 };
      return "$" + num.toLocaleString("en-US", opts) + " USD";
    };
    const fmtUsdPlain = (v) => {
      const num = Number(v);
      if (isNaN(num)) return String(v);
      return "$" + num.toFixed(Number.isInteger(num) ? 0 : 2).replace(/\.00$/, "");
    };
    const fmtNoGroup = (v) => {
      const num = Number(v);
      if (isNaN(num)) return String(v);
      return num.toFixed(Number.isInteger(num) ? 0 : 2).replace(/\.00$/, "");
    };
    const setText = (id, val) => {
      const el = document.getElementById(id);
      if (!el) return; el.textContent = val; el.classList?.remove('skeleton');
    };

    // ===== Mini pie helpers (CSS conic-gradient) =====
    function setPie(el, pct, colorA, colorB){
      if(!el) return;
      const p = Math.max(0, Math.min(100, Number(pct) || 0));
      el.style.background = `conic-gradient(${colorA} 0 ${p}%, ${colorB} 0 ${100}%)`;
    }

    async function fetchNFTData() {
      try {
        const res = await fetch('data.json', { cache: 'no-store' });
        const data = await res.json();

        // Top stats
        setText('treasuryValue', fmtUsdBig(data.treasuryValue));
        setText('stableValue', fmtUsdBig(data.stableValue));
        const stablePct = Number(data.stablePercentage ?? (Number(data.stableValue)/Number(data.treasuryValue)*100));
        setText('stablePercentage', isFinite(stablePct) ? stablePct.toFixed(0) : '—');

        setText('treasuryGen1', fmtUsdBig(data.treasuryGen1));
        setText('treasuryGen2', fmtUsdBig(data.treasuryGen2));

        // NFT values
        setText('nftGen1Value', fmtUsdPlain(data.nftGen1Value));
        setText('nftGen1ValueSol', `${fmtNoGroup(data.nftGen1ValueSol)} SOL`);
        setText('nftGen2Value', fmtUsdPlain(data.nftGen2Value));
        setText('nftGen2ValueSol', `${fmtNoGroup(data.nftGen2ValueSol)} SOL`);

        // Discounts
        setText('gen1ListingPrice', `${fmtUsdPlain(data.gen1ListingPrice)} (${fmtNoGroup(data.gen1ListingPriceSol)} SOL)`);
        setText('gen1Discount', fmtNoGroup(data.gen1Discount));
        setText('gen2ListingPrice', `${fmtUsdPlain(data.gen2ListingPrice)} (${fmtNoGroup(data.gen2ListingPriceSol)} SOL)`);
        setText('gen2Discount', fmtNoGroup(data.gen2Discount));

        // Pies
        const investedPct = isFinite(stablePct) ? (100 - Number(stablePct)) : 0;
        const root = getComputedStyle(document.documentElement);
        setPie(document.getElementById('pieStable'), stablePct, root.getPropertyValue('--accent'), root.getPropertyValue('--secondary'));
        setText('legendStable', `(${Math.round(stablePct)}%)`);
        setText('legendInvested', `(${Math.round(investedPct)}%)`);

        const g1 = Number(data.treasuryGen1);
        const g2 = Number(data.treasuryGen2);
        const totalG = (isFinite(g1) && isFinite(g2) && (g1+g2>0)) ? (g1 + g2) : null;
        let gen1Pct = 90, gen2Pct = 10; // fallback
        if(totalG){ gen1Pct = g1/totalG*100; gen2Pct = g2/totalG*100; }
        setPie(document.getElementById('pieGen'), gen1Pct, root.getPropertyValue('--primary'), root.getPropertyValue('--danger'));
        setText('legendGen1', `(${Math.round(gen1Pct)}%)`);
        setText('legendGen2', `(${Math.round(gen2Pct)}%)`);
        setText('legendGen1Pct', `(${Math.round(gen1Pct)}%)`);
        setText('legendGen2Pct', `(${Math.round(gen2Pct)}%)`);

        // Footnotes
        setText('footUpdated', data.lastUpdated ?? '—');
        setText('marketUpdated', data.lastUpdated ?? '—');
        setText('footSol', fmtUsdPlain(data.solPrice));

      } catch (e) {
        console.error('Error loading data.json', e);
      }
    }

    fetchNFTData();

    // ===== NEW: Logs modal controller =====
    const openBtn = document.getElementById('openLogsBtn');
    const modal = document.getElementById('logsModal');
    const closeBtn = document.getElementById('closeLogsBtn');
    const refreshBtn = document.getElementById('refreshLogsBtn');
    const copyBtn = document.getElementById('copyLogsBtn');
    const logsContent = document.getElementById('logsContent');
    const logsUpdated = document.getElementById('logsUpdated');
    const autoScrollToggle = document.getElementById('autoScrollToggle');
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');

    let refreshTimer = null;

    function escapeHtml(str){
      return str.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    }

    async function loadLogs(){
      try{
        const res = await fetch('logs.txt?ts=' + Date.now(), { cache: 'no-store' });
        if(!res.ok){
          logsContent.textContent = 'logs.txt not found yet. Run the workflow once to generate it.';
          logsUpdated.textContent = '—';
          return;
        }
        const txt = await res.text();
        // Light post-processing: keep exactly as-is, just escape HTML
        logsContent.innerHTML = escapeHtml(txt);
        logsUpdated.textContent = new Date().toLocaleString();
        if(autoScrollToggle.checked){
          logsContent.parentElement.scrollTop = logsContent.parentElement.scrollHeight;
        }
      }catch(err){
        logsContent.textContent = 'Error loading logs.txt: ' + err;
        logsUpdated.textContent = '—';
      }
    }

    function openModal(){
      modal.classList.add('open');
      loadLogs();
      if(autoRefreshToggle.checked){
        startAutoRefresh();
      }
      // Close on backdrop click
      modal.addEventListener('click', backdropCloseHandler);
      // Esc key
      document.addEventListener('keydown', escHandler);
    }

    function closeModal(){
      modal.classList.remove('open');
      stopAutoRefresh();
      modal.removeEventListener('click', backdropCloseHandler);
      document.removeEventListener('keydown', escHandler);
    }

    function backdropCloseHandler(e){
      if(e.target === modal){ closeModal(); }
    }
    function escHandler(e){
      if(e.key === 'Escape'){ closeModal(); }
    }

    function startAutoRefresh(){
      stopAutoRefresh();
      refreshTimer = setInterval(loadLogs, 5000);
    }
    function stopAutoRefresh(){
      if(refreshTimer){ clearInterval(refreshTimer); refreshTimer = null; }
    }

    // Wire up controls
    openBtn?.addEventListener('click', openModal);
    closeBtn?.addEventListener('click', closeModal);
    refreshBtn?.addEventListener('click', loadLogs);
    autoRefreshToggle?.addEventListener('change', (e)=> e.target.checked ? startAutoRefresh() : stopAutoRefresh());
    copyBtn?.addEventListener('click', async ()=>{
      try{
        const text = logsContent.textContent || '';
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = 'Copied!';
        setTimeout(()=> copyBtn.textContent = 'Copy', 1200);
      }catch(_){}
    });
  </script>
</body>
</html>
